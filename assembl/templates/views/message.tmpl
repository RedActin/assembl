{% set userName = "<%= creator.get('name') %>" %}
{% set precise_date = "<%= ctx.getReadableDateTime(date) %>" %}
{% set nice_date = "<%= ctx.getNiceDateTime(date) %>" %}
{% macro readUnreadIndicator() -%}
  <% if ( user_is_connected ){ %>{# Strip whitespace ...
      #}<span class="readUnreadIndicator indice 
      <% if (read){ %>
        js_message-markasunread
      <% } else { %>
        js_message-markasread
      <% } %>"
      data-toggle="tooltip" title="
      <% if (read){ %>
        {{ gettext('Mark as unread') }}
      <% } else { %>
        {{ gettext('Mark as read') }}
      <% } %>"
      data-placement="left"
      >
      </span>{# Strip whitespace ...
      #}<% } %>
{%- endmacro %}

<% if ( viewStyle == ctx.AVAILABLE_MESSAGE_VIEW_STYLES.TITLE_ONLY ){ %>
  <div class="leftSection">
    <div class="avatar">
      <img src="<%= creator.getAvatarUrl(30) %>" alt="{{ gettext('User') }}"  class="image-rounded" width="30" height="30" />
    </div>{# Strip whitespace ...
    #}{{ readUnreadIndicator() }}{# Strip whitespace ...
    #}<span class="message-author js_messageHeader">{{ gettext('%(user)s')|format(user=userName)|safe }}</span>
  </div>
  <div class="rightSection">
    <span class="message-date js_messageHeader">{{ gettext('<time title="%(precise_date)s">%(nice_date)s</time>')|format(nice_date=nice_date,precise_date=precise_date)|safe }}</span>
  </div>
  <div class="centerSection">
    <div class="message-subject js_messageHeader">
      <span class="message-title"><%= subject %></span>
      <span class="message-body <%= bodyFormatClass %>" id="<%= messageBodyId %>"><%= body %></span>
    </div>
  </div>

<% } else { %>
  <div class="avatar">
    <img src="<%= creator.getAvatarUrl(30) %>" alt="{{ gettext('User') }}"  class="image-rounded" width="30" height="30" />
  </div>
  {{ readUnreadIndicator() }}
  <span class="message-author js_messageHeader">{{ gettext('%(user)s')|format(user=userName)|safe }}</span>
  <span class="message-date js_messageHeader">{{ gettext('<time title="%(precise_date)s">%(nice_date)s</time>')|format(nice_date=nice_date,precise_date=precise_date)|safe }}</span>
  <span class="message-subject js_messageHeader"><%= subject %></span>
<% } %>

<% if ( viewStyle == ctx.AVAILABLE_MESSAGE_VIEW_STYLES.FULL_BODY ){ %>
  <div class="message-menu">
    <div class="dropdown">
      <span class="dropdown-label">{{ gettext('More options') }}&nbsp;<i class="icon-arrowdown"></i></span>
      <ul class="dropdown-list dropdown-list--bottomright">
        <% if (user_is_connected){ %>
          <% if (read){ %>
            <li class="js_message-markasunread dropdown-listitem"><a class="iconbutton"></a> {{ gettext('Mark as unread') }}</li>
          <% } else { %>
            <li class="js_message-markasread dropdown-listitem"><a class="iconbutton"></a> {{ gettext('Mark as read') }}</li>
          <% } %>
        <% } %>

        <% if( isHoisted == true ){ %>
          <li class="dropdown-listitem message-hoistbtn" data-id="<%= escape(id) %>"><a class="iconbutton icon-upload"></a> {{gettext('Go back to the entire topic thread')}}</li>
        <% } else { %>
          <li class="dropdown-listitem message-hoistbtn" data-id="<%= escape(id) %>"><a class="iconbutton icon-download"></a> {{gettext('Show only this message and its replies')}}</li>
        <% } %>

        <li class="dropdown-listitem message-linkbutton" data-copy-text="/message/<%= escape(id) %>"><a class="iconbutton icon-link"></a> {{gettext('Copy the link to share this message')}}</li>

        <% if (creator.get('email')) { %>
        <li class="dropdown-listitem">
          <a title="<%= creator.get('email') %>" href="mailto:<%= creator.get('email') %>"><i class="iconbutton icon-mail"></i>
          {{gettext('Send an email to this user')}}</a>
        </li>
        <% } %>
      </ul>
    </div>
  </div>
<% } %>

<% if( viewStyle == ctx.AVAILABLE_MESSAGE_VIEW_STYLES.PREVIEW || viewStyle == ctx.AVAILABLE_MESSAGE_VIEW_STYLES.FULL_BODY ){ %>
  {#  Body section
      Note:  bodyFormatClass can currently have values body_format_text_plain or  body_format_text_html 
  #}
  <% if( viewStyle == ctx.AVAILABLE_MESSAGE_VIEW_STYLES.PREVIEW ){ %>
    <div class="message-body <%= bodyFormatClass %> ellipsis" id="<%= messageBodyId %>">
      <p class="mvn more"><%= body %></p>{# Do NOT introduce whitespace within this div #}
      <a class="readMore readMoreOrLess js_readMore hidden" href="#" alt="{{ gettext('Read more') }}">{{ gettext('Read more') }}</a>
    </div>
  <% } else if( viewStyle == ctx.AVAILABLE_MESSAGE_VIEW_STYLES.FULL_BODY ){ %>
    <div class="message-body js_messageBodyAnnotatorSelectionAllowed <%= bodyFormatClass %>" id="<%= messageBodyId %>"><%= body %></div>
    <a class="readLess readMoreOrLess js_readLess hidden" href="#" alt="{{ gettext('Read less') }}">{{ gettext('Read less') }}</a>
    <div class="message-replybox"></div>
  <% } %>
  <div class="message-menu message-menu-actions">
    {#
    <% if( isHoisted == true ){ %>
      <a class="message-hoistbtn iconbutton icon-upload" data-id="<%= escape(id) %>" data-toggle="tooltip" title="{{gettext('Go back to the entire topic thread')}}"></a>
    <% } else { %>
      <a class="message-hoistbtn iconbutton icon-download" data-id="<%= escape(id) %>" data-toggle="tooltip" title="{{gettext('Show only this message and its replies')}}"></a>
    <% } %>
    #}

    <% if( viewStyle == ctx.AVAILABLE_MESSAGE_VIEW_STYLES.PREVIEW ){ %>
      <a class="message-replybox-openbtn"><i class="icon-answer"></i>&nbsp;&nbsp;{{ gettext("Reply") }}</a>
      <div class="fr">
        <% if(nuggets){ %>
          <span class="nb-nuggets"><i class="icon-diamond"></i><span><%= nuggets %></span></span>
        <% } %>
      </div>
    <% } %>
  </div>
<% } %>
